# 安装依赖（适用于Colab）
!pip install python-docx googletrans==4.0.0-rc1 tqdm -q

from googletrans import Translator
from docx import Document
from docx.shared import Pt
from google.colab import files
from tqdm import tqdm
import time

translator = Translator(service_urls=['translate.google.com'])

def translate_text(text):
    if not text.strip():
        return text
    try:
        result = translator.translate(text, src='en', dest='zh-cn')
        return result.text
    except Exception as e:
        print("翻译错误:", e)
        return text

# 上传Word文件
uploaded = files.upload()
input_path = list(uploaded.keys())[0]

# 打开Word文档
doc = Document(input_path)
print(f"开始翻译 {len(doc.paragraphs)} 个段落...")

# 翻译每段
for para in tqdm(doc.paragraphs):
    if not para.text.strip():
        continue
    translated_text = translate_text(para.text)
    time.sleep(0.5)  # 防止被Google限流

    # 删除原有Run
    for _ in range(len(para.runs)):
        para.runs[0]._element.getparent().remove(para.runs[0]._element)
    
    # 添加翻译文本为新的Run
    new_run = para.add_run(translated_text)
    new_run.font.size = Pt(11)

# 保存新文档
output_path = "translated_output.docx"
doc.save(output_path)
print(f"翻译完成，保存为 {output_path}")

# 下载文件
files.download(output_path)
