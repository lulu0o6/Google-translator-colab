# å®‰è£…ä¾èµ–
!apt-get install -y libreoffice ocrmypdf tesseract-ocr tesseract-ocr-chi-sim > /dev/null
!pip install deep-translator python-docx tqdm PyMuPDF -q

from deep_translator import GoogleTranslator
from docx import Document
from docx.shared import Pt
from google.colab import files
from tqdm import tqdm
import fitz  # PyMuPDF
import time
import os

# ç¿»è¯‘å‡½æ•°
def translate_text(text):
    if not text.strip():
        return text
    try:
        return GoogleTranslator(source='auto', target='zh-CN').translate(text)
    except Exception as e:
        print("ç¿»è¯‘é”™è¯¯:", e)
        return text

# ä¸Šä¼  PDF æ–‡ä»¶
uploaded = files.upload()
input_pdf_path = list(uploaded.keys())[0]

# å°è¯•è¯»å–æ–‡å­—ï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦ OCR
doc = fitz.open(input_pdf_path)
has_text = any(page.get_text("text").strip() for page in doc)

# å¦‚æœæ²¡æœ‰å¯é€‰æ–‡å­—ï¼Œæ‰§è¡Œ OCR é¢„å¤„ç†
if not has_text:
    print("âš ï¸ åŸå§‹ PDF æ— å¯é€‰æ–‡å­—ï¼Œæ­£åœ¨æ‰§è¡Œ OCR è¯†åˆ«...")
    ocr_output_path = "ocr_output.pdf"
    !ocrmypdf --skip-text --language eng+nld+chi_sim "{input_pdf_path}" "{ocr_output_path}"
    pdf_path_to_use = ocr_output_path
    print("âœ… OCR å®Œæˆï¼Œå·²ç”Ÿæˆå«æ–‡å­—çš„ PDF")
else:
    print("âœ… æ£€æµ‹åˆ°å¯é€‰æ–‡å­—ï¼Œè·³è¿‡ OCR")
    pdf_path_to_use = input_pdf_path

# é‡æ–°è¯»å–ï¼ˆOCR åï¼‰
pdf_doc = fitz.open(pdf_path_to_use)
total_pages = len(pdf_doc)
translated_doc = Document()

print(f"\nğŸ“– å¼€å§‹ç¿»è¯‘å…± {total_pages} é¡µçš„ PDF å†…å®¹...\n")

# ç¿»è¯‘æ¯ä¸€é¡µ
for page_num, page in enumerate(tqdm(pdf_doc, desc="ğŸ“„ ç¿»è¯‘ä¸­"), start=1):
    page_header = f"ğŸ“„ ç¬¬ {page_num} é¡µ"
    header_para = translated_doc.add_paragraph()
    header_run = header_para.add_run(page_header)
    header_run.font.size = Pt(13)
    header_run.bold = True

    text = page.get_text("text")
    lines = [line.strip() for line in text.split('\n') if line.strip()]
    for para_text in tqdm(lines, desc=f"â†³ ç¬¬ {page_num} é¡µæ®µè½ç¿»è¯‘", leave=False):
        translated = translate_text(para_text)
        time.sleep(0.5)
        para = translated_doc.add_paragraph()
        run = para.add_run(translated)
        run.font.size = Pt(11)

# ä¿å­˜ Word æ–‡ä»¶
docx_output = "translated_output.docx"
translated_doc.save(docx_output)

# è½¬æ¢ä¸º PDF
!libreoffice --headless --convert-to pdf "{docx_output}" > /dev/null

# ä¸‹è½½ PDF
pdf_output = "translated_output.pdf"
print("\nâœ… ç¿»è¯‘å®Œæˆï¼Œç”Ÿæˆ PDF æ–‡ä»¶ âœ…")
files.download(pdf_output)
